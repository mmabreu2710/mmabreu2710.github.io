# Challenge "Super Serial" Writeup

## Vulnerability: PHP Object Injection via Cookie Deserialization

### Where: `authentication.php` and `access_log` class

### Impact: This challenge demonstrates how PHP object injection can be exploited when user-controlled data is deserialized, allowing access to sensitive information such as the flag.

**NOTE**: The challenge involves crafting a serialized `access_log` object to exploit the `__toString` method, enabling us to read arbitrary files.

## Steps to reproduce:

1. **Identify the Vulnerability in Cookie Deserialization**:
   The `authentication.php` code reads a `login` cookie, decodes and unserializes it. Since we control this `login` cookie, we can inject any object, and it will be instantiated upon deserialization.

   The code includes the `access_log` class, which has a `__toString` method that automatically calls `read_log()` when the object is printed. We can leverage this to read the contents of any file specified in the `log_file` property.

2. **Craft the Payload**:
   By setting `log_file` to `../flag`, we can read the `../flag` file's contents. Hereâ€™s what the serialized payload looks like:

   ```
   O:10:"access_log":1:{s:8:"log_file";s:7:"../flag";}
   ```

   Using CyberChef, we base64-encoded and URL-encoded this payload, resulting in:

   ```
   TzoxMDoiYWNjZXNzX2xvZyI6MTp7czo4OiJsb2dfZmlsZSI7czo3OiIuLi9mbGFnIjt9
   ```

3. **Inject the Payload Using a Cookie**:
   We use `cURL` to send the request to `authentication.php` with the crafted cookie:

   ```
   curl mercury.picoctf.net:3449/authentication.php --cookie "login=TzoxMDoiYWNjZXNzX2xvZyI6MTp7czo4OiJsb2dfZmlsZSI7czo3OiIuLi9mbGFnIjt9"
   ```

4. **Retrieve the Flag**:
   This request triggers a deserialization error because `access_log` does not have an `is_guest` method. When the error is caught, it attempts to print the `login` object (our injected `access_log`), which calls `__toString()` and displays the contents of `../flag`.

   The output reveals the flag:

   ```
   picoCTF{th15_vu1n_1s_5up3r_53r1ous_y4ll_b4e3f8b1}
   ```

## Conclusion:

By crafting a serialized `access_log` object and injecting it into the `login` cookie, we exploited the PHP object injection vulnerability to read the contents of `../flag`, successfully retrieving the flag and completing the challenge.
